---
- name: "Deploy and Start a New VM from Proxmox Template"
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - secrets.yml

  vars:
    proxmox_host: "192.168.210.135"
    proxmox_user: "root@pam"
    proxmox_token_id: "demov1"
    proxmox_api_secret: "{{ proxmox_api_secret }}"
    proxmox_node: "pve"
    template_vmid: 100
    new_vmid: 100
    new_vm_name: "freshbakevm-ubuntu"

  tasks:
    - name: "Clone template {{ template_vmid }} to new VM {{ new_vmid }}"
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_api_secret }}"
        node: "{{ proxmox_node }}"
        clone: "{{ template_vmid }}"
        vmid: "{{ new_vmid }}"
        name: "{{ new_vm_name }}"
        timeout: 600
      register: clone_result

    - name: "Remove template flag using qm command"
      ansible.builtin.shell:
        cmd: "qm set {{ new_vmid }} --template 0"
      environment:
        PM_API_URL: "https://{{ proxmox_host }}:8006/api2/json"
        PM_USER: "{{ proxmox_user }}"
        PM_TOKEN_ID: "{{ proxmox_token_id }}"
        PM_TOKEN_SECRET: "{{ proxmox_api_secret }}"
      when: clone_result.changed
      register: qm_result
      retries: 3
      delay: 5

    - name: "Configure VM disk to be writable"
      ansible.builtin.shell:
        cmd: "qm set {{ new_vmid }} --scsi0 {{ proxmox_node }}:vm-{{ new_vmid }}-disk-0,cache=writeback,discard=on"
      environment:
        PM_API_URL: "https://{{ proxmox_host }}:8006/api2/json"
        PM_USER: "{{ proxmox_user }}"
        PM_TOKEN_ID: "{{ proxmox_token_id }}"
        PM_TOKEN_SECRET: "{{ proxmox_api_secret }}"
      when: clone_result.changed
      register: disk_config_result
      retries: 3
      delay: 2

    - name: "Wait 10 seconds after configuration"
      ansible.builtin.wait_for:
        timeout: 10
      when: disk_config_result.changed

    - name: "Start the newly created VM {{ new_vmid }}"
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_api_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ new_vmid }}"
        state: started
      retries: 10
      delay: 5
      until: true
      ignore_errors: yes
      when: clone_result.changed