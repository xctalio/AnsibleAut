- name: "Clone template {{ template_vmid }} to new VM {{ new_vmid }}"
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_api_secret }}"
    node: "{{ proxmox_node }}"
    clone: "{{ template_vmid }}"
    vmid: "{{ new_vmid }}"
    name: "{{ new_vm_name }}"
  register: clone_result  # Catat hasil kloning

- name: "Tunggu 30 detik untuk proses kloning selesai"
  ansible.builtin.wait_for:
    timeout: 30
  when: clone_result.changed  # Hanya tunggu jika kloning berhasil

- name: "Start the newly created VM {{ new_vmid }}"
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_host }}"
    api_user: "{{ proxmox_user }}"
    api_token_id: "{{ proxmox_token_id }}"
    api_token_secret: "{{ proxmox_api_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ new_vmid }}"
    state: started