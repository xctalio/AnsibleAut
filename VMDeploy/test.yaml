---
- name: "Clone VM with Auto VM ID"
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - secrets.yml

  vars:
    proxmox_host: "192.168.210.135"
    proxmox_user: "root@pam"
    proxmox_token_id: "demov1"
    proxmox_api_secret: "{{ proxmox_api_secret }}"
    proxmox_node: "pve"
    template_vmid: 100

  tasks:
    - name: "Get used VM IDs via SSH"
      become: yes
      shell:
        cmd: "qm list | awk 'NR>1 {print $1}'"
      register: used_vm_ids

    - name: "Find available VM ID starting from 900"
      set_fact:
        new_vmid: "{{ item }}"
      with_sequence: start=900 end=999
      when: item not in used_vm_ids.stdout_lines
      register: available_id
      ignore_errors: yes

    - name: "Clone template to new VM"
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_api_secret }}"
        node: "{{ proxmox_node }}"
        clone: "{{ template_vmid }}"
        vmid: "{{ new_vmid }}"
        name: "clone-{{ new_vmid }}"
        timeout: 300
      when: available_id is defined